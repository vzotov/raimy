services:
  auth-service:
    build: ./auth-service
    ports:
      - "8001:8001"  # Auth microservice
    environment:
      - PYTHONPATH=/app
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - JWT_SECRET=${JWT_SECRET:-jwt-secret-key}
      - AUTH_DEBUG=${AUTH_DEBUG:-false}
      - SERVICE_API_KEY=${SERVICE_API_KEY}
      - API_URL=${API_URL:-http://localhost:8000}
    volumes:
      # Mount for development auto-reload
      - ./auth-service:/app
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  raimy-api:
    build: .
    ports:
      - "8000:8000"  # FastAPI server
    environment:
      - PYTHONPATH=/app/server
      # Add your environment variables here
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - LIVEKIT_URL=${LIVEKIT_URL}
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
      - AUTH_SERVICE_URL=http://auth-service:8001
      - SERVICE_API_KEY=${SERVICE_API_KEY}
      - FIREBASE_EMULATOR_HOST=firebase-emulator
      - FIREBASE_EMULATOR_PORT=8080
      - FIRESTORE_EMULATOR_HOST=firebase-emulator:8080
    volumes:
      # Mount for development (optional)
      - ./server:/app/server
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      auth-service:
        condition: service_healthy
      firebase-emulator:
        condition: service_healthy

  raimy-bot:
    build: .
    command: ["python", "server/main.py", "start"]
    environment:
      - PYTHONPATH=/app/server
      - API_URL=http://raimy-api:8000
      - AUTH_SERVICE_URL=http://auth-service:8001
      - SERVICE_API_KEY=${SERVICE_API_KEY}
      # Add your environment variables here
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - LIVEKIT_URL=${LIVEKIT_URL}
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
      - FIREBASE_EMULATOR_HOST=firebase-emulator
      - FIREBASE_EMULATOR_PORT=8080
      - FIRESTORE_EMULATOR_HOST=firebase-emulator:8080
    volumes:
      # Mount for development (optional)
      - ./server:/app/server
    restart: unless-stopped
    depends_on:
      raimy-api:
        condition: service_healthy

  firebase-emulator:
    image: node:22-alpine
    ports:
      - "4000:4000"  # Emulator UI
      - "8080:8080"  # Firestore
      - "9099:9099"  # Auth
      - "5001:5001"  # Functions
    environment:
      - FIRESTORE_EMULATOR_HOST=0.0.0.0:8080
      - AUTH_EMULATOR_HOST=0.0.0.0:9099
      - FUNCTIONS_EMULATOR_HOST=0.0.0.0:5001
    volumes:
      - ./firebase:/app
      - firebase-data:/root/.config/firebase
      - firestore-data:/root/.config/firebase/firestore-data
      - ./firebase-data:/root/.config/firebase/data
    working_dir: /app
    command: >
      sh -c "
        apk add --no-cache openjdk11-jre wget &&
        npm install -g firebase-tools &&
        firebase emulators:start --project demo-project --only firestore,auth,ui
      "
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  firebase-data:
  firestore-data: 